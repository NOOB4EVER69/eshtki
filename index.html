<!DOCTYPE html>
<!-- REMOVED: Dark mode class removed -->
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eshtki</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
      REMOVED: Leaflet CSS and JS are now loaded dynamically (lazy-loaded)
      to improve initial page load speed. See loadLeaflet() in the script.
    -->

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', 'Cairo', sans-serif;
            /* NEW: Set to 'zinc-50' for a soft off-white */
            background-color: #fafafa;
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* REMOVED: Dark mode base */

        /* Fix for Leaflet map height */
        #map,
        #submit-map,
        #detail-map {
            height: 300px;
            width: 100%;
            border-radius: 0.75rem;
            /* rounded-xl */
            z-index: 10;
        }

        /* Profile map */
        #profile-map {
            height: 250px;
            width: 100%;
            border-radius: 0.75rem;
            /* rounded-xl */
            z-index: 10;
        }

        #submit-map {
            cursor: crosshair;
        }

        /* RTL support for Tailwind */
        html[dir="rtl"] {
            direction: rtl;
        }

        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0d9488;
            /* Tailwind 'teal-600' */
            animation: spin 1s ease infinite;
        }

        /* REMOVED: Dark mode spinner */

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom class for active sort/view buttons */
        .btn-active {
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            color: #0d9488;
            /* teal-600 */
        }

        /* REMOVED: Dark mode btn-active */

        /* Vote status in comments */
        .vote-status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-inline-end: 8px;
            /* Use logical property */
        }

        .vote-status-agree {
            background-color: #dcfce7;
            color: #166534;
        }

        /* REMOVED: Dark mode vote-status-agree */

        .vote-status-disagree {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* REMOVED: Dark mode vote-status-disagree */

        /* Report category colors */
        .category-traffic {
            border-inline-end: 4px solid #3b82f6;
            /* Use logical property */
        }

        .category-noise {
            border-inline-end: 4px solid #f59e0b;
            /* Use logical property */
        }

        .category-cleanliness {
            border-inline-end: 4px solid #10b981;
            /* Use logical property */
        }

        .category-services {
            border-inline-end: 4px solid #8b5cf6;
            /* Use logical property */
        }

        .category-environment {
            border-inline-end: 4px solid #06b6d4;
            /* Use logical property */
        }

        .category-safety {
            border-inline-end: 4px solid #ef4444;
            /* Use logical property */
        }

        /* Custom marker styles */
        .category-marker {
            background: transparent !important;
            border: none !important;
        }

        /* Verified Badge Icon */
        .verified-badge {
            color: #3b82f6;
            /* blue-500 */
            font-size: 0.9em;
            /* Slightly smaller */
            margin-inline-end: 4px;
            /* Use logical property */
        }

        /* Mobile Nav Menu */
        #mobile-menu {
            transition: transform 0.3s ease-in-out;
        }

        /* REMOVED: Dark mode for Leaflet map tiles */

        /* NEW: Skeleton Loader styles */
        .skeleton-card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* REMOVED: Dark mode skeleton-card */

        .skeleton-line {
            background-color: #e2e8f0;
            /* slate-200 */
            border-radius: 0.25rem;
            height: 1rem;
        }

        /* REMOVED: Dark mode skeleton-line */

        @keyframes pulse {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-zinc-50 text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="spinner"></div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 end-5 z-50 space-y-2"></div>

    <!-- Navigation Bar -->
    <nav class="bg-white/90 backdrop-blur-sm shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <!-- TODO: Replace this div with your <img> tag when you have a logo -->
                    <div id="logo-container"
                        class="w-8 h-8 bg-teal-600 rounded-lg flex items-center justify-center text-white font-bold me-2 text-lg flex-shrink-0">
                        E</div>
                    <span class="font-bold text-xl text-slate-800">Eshtki</span>
                </div>

                <!-- Desktop Nav Links -->
                <div id="nav-links-desktop" class="hidden md:flex items-center gap-4">
                    <!-- Nav links injected by JS -->
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-slate-700 hover:text-teal-600 focus:outline-none">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Menu (Dropdown) -->
        <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg absolute top-16 inset-x-0 z-30 p-4 border-t">
            <div id="nav-links-mobile" class="flex flex-col gap-4">
                <!-- Mobile nav links injected by JS -->
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8">

        <!-- Login Page -->
        <section id="login-page" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-6">تسجيل الدخول</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-slate-700">البريد
                            الإلكتروني</label>
                        <input type="email" id="login-email" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-slate-700">كلمة المرور</label>
                        <input type="password" id="login-password" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit"
                        class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-200 transform hover:scale-105">
                        دخول
                    </button>
                </form>
                <p class="text-center text-sm text-slate-600 mt-4">
                    ليس لديك حساب؟ <a href="#register"
                        class="font-medium text-teal-600 hover:text-teal-500 page-link">إنشاء حساب جديد</a>
                </p>
            </div>
        </section>

        <!-- Registration Page -->
        <section id="register-page" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-6 md:p-8 rounded-xl shadow-xl">
                <h2 class="text-2xl font-bold text-center mb-6">إنشاء حساب جديد</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="reg-name" class="block text-sm font-medium text-slate-700">الاسم الرباعي (كما في
                            البطاقة - باللغة العربية)</label>
                        <input type="text" id="reg-name" required pattern="^[\u0621-\u064A\s]{4,}$"
                            title="الرجاء إدخال اسم رباعي باللغة العربية"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="reg-nid" class="block text-sm font-medium text-slate-700">الرقم القومي (14
                            رقم)</label>
                        <input type="text" id="reg-nid" required maxlength="14" pattern="\d{14}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                        <p id="nid-error" class="text-red-500 text-sm hidden"></p>
                        <p id="nid-success" class="text-green-500 text-sm hidden"></p>
                    </div>

                    <!-- REMOVED: WhatsApp Verification UI -->
                    <div>
                        <label for="reg-phone" class="block text-sm font-medium text-slate-700">رقم الهاتف</label>
                        <input type="tel" id="reg-phone" required
                            class="flex-grow block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"
                            placeholder="e.g. 01001234567">
                    </div>

                    <div>
                        <label for="reg-email" class="block text-sm font-medium text-slate-700">البريد
                            الإلكتروني (سيتم إرسال رابط تحقق)</label>
                        <input type="email" id="reg-email" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="reg-password" class="block text-sm font-medium text-slate-700">كلمة المرور</label>
                        <input type="password" id="reg-password" required minlength="6"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>

                    <!-- NEW: reCAPTCHA -->
                    <div class="flex justify-center">
                        <div class="g-recaptcha my-4" data-sitekey="6Lc5QwosAAAAAG140Oy11EY4eKu129EOs7YBcfm3"></div>
                    </div>
                    <p id="recaptcha-error" class="text-red-500 text-sm text-center hidden"></p>


                    <p id="register-error" class="text-red-500 text-sm hidden"></p>

                    <button type="submit" id="register-submit-btn"
                        class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-200 transform hover:scale-105">
                        تسجيل
                    </button>
                </form>
                <p class="text-center text-sm text-slate-600 mt-4">
                    لديك حساب بالفعل؟ <a href="#login"
                        class="font-medium text-teal-600 hover:text-teal-500 page-link">تسجيل الدخول</a>
                </p>
            </div>
        </section>

        <!-- Email Verification Sent Page -->
        <section id="email-verify-page" class="page hidden">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-xl text-center">
                <i class="fa-solid fa-envelope-circle-check text-5xl text-green-500 mb-4"></i>
                <h2 class="text-2xl font-bold mb-4">تم إرسال رابط التحقق!</h2>
                <p class="text-slate-600 mb-6">
                    تم إرسال رابط تحقق إلى بريدك الإلكتروني. الرجاء الضغط على الرابط في الرسالة لتفعيل حسابك.
                </p>
                <p class="text-sm text-slate-500 mb-6">(تأكد من مراجعة ملف الرسائل غير المرغوب فيها "Spam")</p>
                <a href="#login"
                    class="page-link w-full bg-teal-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-teal-700">
                    الذهاب لتسجيل الدخول
                </a>
            </div>
        </section>


        <!-- Main Feed Page -->
        <section id="main-page" class="page hidden">
            <!-- Filters and View Toggles -->
            <div
                class="mb-6 bg-white p-4 rounded-xl shadow-md flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-wrap gap-4 justify-center w-full md:w-auto">
                    <!-- REMOVED: Governorate Filter -->

                    <!-- Category Filter -->
                    <select id="category-filter"
                        class="w-full sm:w-auto border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm flex-grow">
                        <option value="all">كل الفئات</option>
                        <option value="traffic">المرور والطرق</option>
                        <option value="noise">الضوضاء والإزعاج</option>
                        <option value="cleanliness">النظافة العامة</option>
                        <option value="services">الخدمات الحكومية</option>
                        <option value="environment">البيئة والصحة</option>
                        <option value="safety">الأمن والأمان</option>
                    </select>

                    <!-- Sort Buttons -->
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button id="sort-newest-btn" data-sort="newest"
                            class="sort-btn btn-active px-4 py-1.5 rounded-md text-sm font-medium">الأحدث</button>
                        <button id="sort-hot-btn" data-sort="hot"
                            class="sort-btn px-4 py-1.5 rounded-md text-sm font-medium text-slate-600">الأكثر
                            تفاعلاً</button>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button id="feed-view-btn" class="view-btn btn-active px-4 py-1.5 rounded-md text-sm"><i
                            class="fa-solid fa-list me-2"></i>عرض كقائمة</button>
                    <button id="map-view-btn" class="view-btn px-4 py-1.5 rounded-md text-sm text-slate-600"><i
                            class="fa-solid fa-map me-2"></i>عرض على
                        الخريطة</button>
                </div>
            </div>

            <!-- Feed View -->
            <div id="feed-view">
                <div id="complaints-feed" class="space-y-6">
                    <!-- Skeletons or Complaints injected by JS -->
                </div>
            </div>

            <!-- Map View -->
            <div id="map-view" class="hidden relative">
                <div id="map" class="rounded-xl shadow-lg"></div>

                <!-- Map Legend -->
                <!-- NEW: Moved to top-4 end-4 -->
                <div id="map-legend" class="absolute top-4 end-4 bg-white p-3 rounded-lg shadow-lg z-20 border">
                    <h4 class="font-bold text-sm mb-2">مفتاح الخريطة</h4>
                    <ul class="space-y-1 text-xs">
                        <!-- Legend items injected by JS -->
                    </ul>
                </div>

            </div>

            <!-- Add Complaint Button -->
            <!-- NEW: Moved to bottom-4 end-4 -->
            <button id="show-submit-form-btn"
                class="fixed bottom-4 end-4 bg-teal-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 z-30 transition transform hover:scale-110">
                <i class="fa-solid fa-plus"></i>
            </button>
        </section>

        <!-- Submit Complaint Page -->
        <section id="submit-complaint-page" class="page hidden">
            <div class="max-w-2xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6">تقديم شكوى جديدة</h2>
                <form id="submit-complaint-form" class="space-y-4">
                    <button type="button" class="page-link text-teal-600 hover:text-teal-800" data-target="main">
                        <i class="fa-solid fa-arrow-right me-2"></i> العودة للرئيسية
                    </button>

                    <!-- REMOVED: Governorate/Category grid -->
                    <div>
                        <label for="complaint-category" class="block text-sm font-medium text-slate-700">الفئة</label>
                        <select id="complaint-category" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            <option value="" disabled selected>اختر فئة...</option>
                            <option value="traffic">المرور والطرق</option>
                            <option value="noise">الضوضاء والإزعاج</option>
                            <option value="cleanliness">النظافة العامة</option>
                            <option value="services">الخدمات الحكومية</option>
                            <option value="environment">البيئة والصحة</option>
                            <option value="safety">الأمن والأمان</option>
                        </select>
                    </div>

                    <div>
                        <label for="complaint-description" class="block text-sm font-medium text-slate-700">وصف
                            الشكوى</label>
                        <textarea id="complaint-description" rows="4" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"
                            placeholder="اكتب تفاصيل المشكلة هنا..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700">الموقع</label>
                        <p class="text-sm text-slate-500">انقر على الخريطة لتحديد موقع الشكوى بدقة.</p>
                        <div id="submit-map" class="mt-2"></div>
                        <input type="hidden" id="complaint-lat">
                        <input type="hidden" id="complaint-lng">
                        <p id="location-coords" class="text-sm text-green-600 mt-1 hidden"></p>
                    </div>

                    <div>
                        <label for="complaint-image-url" class="block text-sm font-medium text-slate-700">رابط صورة
                            (اختياري)</label>
                        <input type="url" id="complaint-image-url"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"
                            placeholder="https://example.com/image.jpg">
                    </div>

                    <div>
                        <label for="complaint-video-url" class="block text-sm font-medium text-slate-700">رابط فيديو
                            (اختياري)</label>
                        <input type="url" id="complaint-video-url"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"
                            placeholder="https://youtube.com/watch?v=...">
                    </div>

                    <div class="flex items-center">
                        <input id="complaint-anonymous" type="checkbox"
                            class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                        <label for="complaint-anonymous" class="ms-2 block text-sm text-slate-900">نشر الشكوى كمستخدم
                            مجهول</label>
                    </div>
                    <p class="text-xs text-slate-500">ملاحظة: حتى لو اخترت النشر كمجهول، ستظل هويتك الحقيقية معروفة
                        لإدارة الموقع للتحقق من المصداقية.</p>

                    <p id="submit-complaint-error" class="text-red-500 text-sm hidden"></p>
                    <button type="submit" id="submit-complaint-btn"
                        class="w-full bg-teal-600 text-white py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition transform hover:scale-105">
                        إرسال الشكوى
                    </button>
                </form>
            </div>
        </section>

        <!-- Complaint Detail Page -->
        <section id="complaint-detail-page" class="page hidden">
            <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <button type="button" class="page-link text-teal-600 hover:text-teal-800 mb-4" data-target="main">
                    <i class="fa-solid fa-arrow-right me-2"></i> العودة للرئيسية
                </button>

                <!-- Complaint Content -->
                <div id="complaint-detail-content">
                    <!-- Injected by JS -->
                </div>

                <!-- Complaint Media -->
                <div id="complaint-media" class="mt-4 space-y-2">
                    <!-- Injected by JS -->
                </div>

                <!-- Complaint Map -->
                <h3 class="text-xl font-bold mb-2 mt-6 pt-4 border-t border-gray-200">
                    موقع الشكوى</h3>
                <div id="detail-map" class="rounded-xl"></div>

                <!-- Voting Section -->
                <div class="my-6 border-t border-b py-4">
                    <h3 class="text-lg font-semibold mb-3">هل توافق على أن هذه مشكلة حقيقية؟</h3>
                    <div class="flex space-x-4 space-x-reverse">
                        <button id="upvote-btn"
                            class="flex items-center gap-2 text-slate-600 hover:text-green-600 px-4 py-2 rounded-lg border border-gray-300 hover:border-green-500 transition transform hover:scale-105">
                            <i class="fa-solid fa-thumbs-up"></i>
                            <span>أوافق</span>
                            (<span id="upvote-count">0</span>)
                        </button>
                        <button id="downvote-btn"
                            class="flex items-center gap-2 text-slate-600 hover:text-red-600 px-4 py-2 rounded-lg border border-gray-300 hover:border-red-500 transition transform hover:scale-105">
                            <i class="fa-solid fa-thumbs-down"></i>
                            <span>لا أوافق</span>
                            (<span id="downvote-count">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Comment Section -->
                <div id="comment-section" class="">
                    <h3 class="text-xl font-bold mb-4">التعليقات</h3>

                    <!-- Message shown if not voted -->
                    <p id="vote-message" class="text-sm text-teal-600 mb-4 p-3 bg-teal-50 rounded-lg hidden">
                        <i class="fa-solid fa-lock me-2"></i>
                        يجب أن تصوت أولاً (أوافق / لا أوافق) قبل أن تتمكن من إضافة تعليق.
                    </p>

                    <!-- Form is hidden until user votes -->
                    <form id="comment-form" class="mb-6 hidden">
                        <label for="comment-text" class="block text-sm font-medium text-slate-700">أضف تعليقك</label>
                        <textarea id="comment-text" rows="3" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"
                            placeholder="اكتب تعليقك هنا..."></textarea>
                        <button type="submit" id="submit-comment-btn"
                            class="mt-2 bg-teal-600 text-white py-2 px-4 rounded-lg shadow-sm hover:bg-teal-700 transition transform hover:scale-105">
                            إضافة تعليق
                        </button>
                    </form>

                    <!-- Comment list is always visible -->
                    <div id="comments-list" class="space-y-4">
                        <!-- Comments injected by JS -->
                    </div>
                </div>

            </div>
        </section>

        <!-- NEW: Profile Page -->
        <section id="profile-page" class="page hidden">
            <div class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <button type="button" class="page-link text-teal-600 hover:text-teal-800 mb-4" data-target="main">
                    <i class="fa-solid fa-arrow-right me-2"></i> العودة للرئيسية
                </button>

                <!-- Profile Header -->
                <div id="profile-header-skeleton" class="hidden">
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-200">
                        <div class="w-16 h-16 bg-slate-200 rounded-full flex-shrink-0 skeleton-line">
                        </div>
                        <div class="flex-grow">
                            <div class="skeleton-line h-6 w-1/2 mb-2"></div>
                            <div class="skeleton-line h-4 w-1/4"></div>
                        </div>
                    </div>
                </div>
                <div id="profile-header-content" class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-200">
                    <div
                        class="w-16 h-16 bg-slate-200 rounded-full flex-shrink-0 flex items-center justify-center text-slate-500">
                        <i class="fa-solid fa-user text-3xl"></i>
                    </div>
                    <div>
                        <!-- NEW: Added "مرحباً" to the name -->
                        <h2 id="profile-name" class="text-2xl font-bold text-slate-800">جاري التحميل...</h2>
                        <div id="profile-verified-badge" class="hidden mt-1">
                            <span
                                class="flex items-center gap-1 text-sm font-medium text-blue-600 bg-blue-100 px-3 py-0.5 rounded-full">
                                <i class="fa-solid fa-check-circle"></i>
                                <span>حساب موثق</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-slate-50 p-4 rounded-lg text-center">
                        <span class="block text-2xl font-bold text-teal-600" id="profile-post-count">0</span>
                        <span class="text-sm text-slate-600">إجمالي الشكاوى</span>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg text-center">
                        <span class="block text-2xl font-bold text-green-600" id="profile-agree-count">0</span>
                        <span class="text-sm text-slate-600">مرة "أوافق"</span>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg text-center">
                        <span class="block text-2xl font-bold text-red-600" id="profile-disagree-count">0</span>
                        <span class="text-sm text-slate-600">مرة "لا أوافق"</span>
                    </div>
                </div>

                <!-- User's Posts -->
                <h3 class="text-xl font-bold mb-4">شكاوى هذا المستخدم (العلنية)</h3>
                <div id="profile-complaints-list" class="space-y-4">
                    <!-- Skeletons or complaints injected by JS -->
                </div>


            </div>
        </section>

    </main>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendEmailVerification
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            setDoc,
            getDoc,
            getDocs,
            onSnapshot,
            query,
            where,
            orderBy,
            serverTimestamp,
            writeBatch,
            runTransaction,
            updateDoc,
            increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ========================================================================
        // Firebase Config (Using provided config)
        // ========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDhPtsA0Om6IZnfMJlBQfmmk48Aux6efls",
            authDomain: "eshtki-app.firebaseapp.com",
            projectId: "eshtki-app",
            storageBucket: "eshtki-app.firebasestorage.app",
            messagingSenderId: "882576436757",
            appId: "1:882576436757:web:ec341311af5eb07fee681c",
            measurementId: "G-B4QC9GW3F2"
        };
        // ========================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: App Constants ---
        // REMOVED: GOVERNORATES
        // prettier-ignore
        const CATEGORIES = {
            traffic: { name: "المرور والطرق", icon: "fa-car", color: "#3b82f6" },
            noise: { name: "الضوضاء والإزعاج", icon: "fa-volume-high", color: "#f59e0b" },
            cleanliness: { name: "النظافة العامة", icon: "fa-trash", color: "#10b981" },
            services: { name: "الخدمات الحكومية", icon: "fa-building-columns", color: "#8b5cf6" },
            environment: { name: "البيئة والصحة", icon: "fa-leaf", color: "#06b6d4" },
            safety: { name: "الأمن والأمان", icon: "fa-shield-halved", color: "#ef4444" }
        };

        // --- Global state ---
        let currentUser = null; // Will store { ...user, fullName, isVerified }
        let currentComplaintId = null;
        let currentProfileId = null; // For profile page
        let currentSort = 'newest';
        let grecaptcha = window.grecaptcha || null; // For reCAPTCHA

        // Map state
        let L = window.L; // Leaflet global
        let leafletLoaded = false;
        let mainMap = null;
        let submitMap = null;
        let detailMap = null;
        let submitMarker = null;
        let detailMarker = null;
        let complaintMarkers = {};
        let complaintListeners = []; // To unsubscribe from listeners

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const toastContainer = document.getElementById('toast-container');
        const pages = document.querySelectorAll('.page');
        // REMOVED: htmlElement

        // Nav
        const navLinksDesktop = document.getElementById('nav-links-desktop');
        const navLinksMobile = document.getElementById('nav-links-mobile');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');

        // Auth
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const regNidInput = document.getElementById('reg-nid');
        const nidError = document.getElementById('nid-error');
        const nidSuccess = document.getElementById('nid-success');
        const regPhoneInput = document.getElementById('reg-phone');
        const registerSubmitBtn = document.getElementById('register-submit-btn');

        // Main Page
        const feedViewBtn = document.getElementById('feed-view-btn');
        const mapViewBtn = document.getElementById('map-view-btn');
        const viewBtns = document.querySelectorAll('.view-btn');
        const feedView = document.getElementById('feed-view');
        const mapView = document.getElementById('map-view');
        const complaintsFeed = document.getElementById('complaints-feed');
        const categoryFilter = document.getElementById('category-filter');
        // REMOVED: governorateFilter
        const sortNewestBtn = document.getElementById('sort-newest-btn');
        const sortHotBtn = document.getElementById('sort-hot-btn');
        const sortBtns = document.querySelectorAll('.sort-btn');
        const mapLegend = document.getElementById('map-legend').querySelector('ul');

        // Submit Page
        const showSubmitFormBtn = document.getElementById('show-submit-form-btn');
        const submitComplaintForm = document.getElementById('submit-complaint-form');
        const complaintLat = document.getElementById('complaint-lat');
        const complaintLng = document.getElementById('complaint-lng');
        const locationCoords = document.getElementById('location-coords');
        const complaintImageUrl = document.getElementById('complaint-image-url');
        const complaintVideoUrl = document.getElementById('complaint-video-url');
        // REMOVED: complaintGovernorate

        // Detail Page
        const complaintDetailContent = document.getElementById('complaint-detail-content');
        const complaintMedia = document.getElementById('complaint-media');
        const upvoteBtn = document.getElementById('upvote-btn');
        const downvoteBtn = document.getElementById('downvote-btn');
        const upvoteCount = document.getElementById('upvote-count');
        const downvoteCount = document.getElementById('downvote-count');
        const voteMessage = document.getElementById('vote-message');
        const commentSection = document.getElementById('comment-section');
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.getElementById('comments-list');

        // Profile Page
        const profileHeaderSkeleton = document.getElementById('profile-header-skeleton');
        const profileHeaderContent = document.getElementById('profile-header-content');
        const profileName = document.getElementById('profile-name');
        const profileVerifiedBadge = document.getElementById('profile-verified-badge');
        const profilePostCount = document.getElementById('profile-post-count');
        const profileAgreeCount = document.getElementById('profile-agree-count');
        const profileDisagreeCount = document.getElementById('profile-disagree-count');
        const profileComplaintsList = document.getElementById('profile-complaints-list');
        const profileLogoutBtn = document.getElementById('profile-logout-btn'); // NEW


        // --- Utility Functions ---

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            const icon = isError ? 'fa-solid fa-circle-xmark' : 'fa-solid fa-circle-check';
            const bgColor = isError ? 'bg-red-500' : 'bg-green-500';
            // REMOVED: darkBgColor

            toast.className = `flex items-center gap-3 p-4 rounded-lg shadow-lg text-white ${bgColor} transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
            toast.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);

            // Animate out
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // --- REMOVED: Dark Mode ---
        // REMOVED: applyTheme()
        // REMOVED: toggleTheme()
        // REMOVED: initTheme()

        // --- NEW: Lazy Load Leaflet ---
        async function loadLeaflet() {
            if (leafletLoaded) {
                L = window.L;
                if (L) return Promise.resolve();
                // If L is somehow gone, reset
                leafletLoaded = false;
            }

            console.log("Loading Leaflet...");
            // Show a subtle loading indicator
            loadingOverlay.classList.remove('hidden');

            return new Promise((resolve, reject) => {
                // 1. Load CSS
                if (!document.querySelector('link[href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"]')) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                    document.head.appendChild(link);
                }

                // 2. Load JS
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.async = true;

                script.onload = () => {
                    console.log("Leaflet JS loaded.");
                    L = window.L; // Assign to global
                    leafletLoaded = true;
                    loadingOverlay.classList.add('hidden');
                    resolve();
                };

                script.onerror = () => {
                    console.error("Failed to load Leaflet JS.");
                    loadingOverlay.classList.add('hidden');
                    reject("Failed to load Leaflet JS.");
                };

                document.body.appendChild(script);
            });
        }


        // --- Page/Routing ---

        async function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            const activePage = document.getElementById(`${pageId}-page`);
            if (activePage) {
                activePage.classList.remove('hidden');

                // Special actions on page show
                if (pageId === 'main') {
                    showSubmitFormBtn.classList.remove('hidden');
                    if (mapView.classList.contains('hidden')) {
                        // Feed view is active, just fetch complaints
                        fetchComplaints(); // Re-fetch complaints
                    } else {
                        // Map view is active, load map
                        if (!mainMap) {
                            await initMainMap();
                        }
                        setTimeout(() => {
                            if (mainMap) mainMap.invalidateSize();
                        }, 300);
                        fetchComplaints(); // Re-fetch complaints
                    }
                } else {
                    showSubmitFormBtn.classList.add('hidden');
                }

                if (pageId === 'submit-complaint') {
                    if (!submitMap) {
                        await initSubmitMap();
                    }
                    setTimeout(() => {
                        if (submitMap) submitMap.invalidateSize();
                    }, 300);
                    if (submitMarker) submitMarker.remove();
                    submitMarker = null;
                    locationCoords.classList.add('hidden');
                    complaintLat.value = '';
                    complaintLng.value = '';
                }

                if (pageId === 'complaint-detail') {
                    fetchComplaintDetails();
                }

                if (pageId === 'profile') {
                    loadProfilePage();
                }
            }
            // Close mobile menu on page change
            mobileMenu.classList.add('hidden');
            mobileMenuBtn.innerHTML = `<i class="fa-solid fa-bars text-xl"></i>`;
        }

        async function handleHashChange() {
            const hash = window.location.hash.substring(1) || 'login';
            const pageId = hash.split('?')[0]; // Get page ID, e.g., 'profile'
            const urlParams = new URLSearchParams(hash.split('?')[1]); // Get query params

            // Store IDs globally from hash
            if (pageId === 'complaint-detail') {
                currentComplaintId = urlParams.get('id');
            }
            if (pageId === 'profile') {
                currentProfileId = urlParams.get('id');
            }


            if (currentUser) {
                // NEW: Added 'profile'
                const allowedPages = ['main', 'submit-complaint', 'complaint-detail', 'profile'];
                if (allowedPages.includes(pageId)) {
                    if (pageId === 'complaint-detail' && !currentComplaintId) {
                        await showPage('main');
                    } else {
                        await showPage(pageId);
                    }
                } else {
                    window.location.hash = 'main';
                    await showPage('main');
                }
            } else {
                // Not logged in
                const allowedPages = ['login', 'register', 'email-verify'];
                if (allowedPages.includes(pageId)) {
                    await showPage(pageId);
                } else {
                    window.location.hash = 'login';
                    await showPage('login');
                }
            }
        }

        document.body.addEventListener('click', (e) => {
            let target = e.target.closest('.page-link');
            if (target) {
                e.preventDefault();
                const targetHash = target.getAttribute('href') || target.dataset.target;

                // Stop if it's the same hash
                if (window.location.hash === targetHash) return;

                // Set new hash, which triggers handleHashChange
                window.location.hash = targetHash.replace('#', '');
            }
        });

        // --- Authentication ---

        onAuthStateChanged(auth, async (user) => {
            if (user && user.emailVerified) { // Only consider user "logged in" if email is verified
                console.log("User logged in and verified:", user.uid);

                const userDocRef = doc(db, 'users', user.uid);
                getDoc(userDocRef).then(docSnap => {
                    let fullName = user.displayName || user.email; // Fallback
                    let isVerifiedAdmin = false; // Admin badge status

                    if (docSnap.exists()) {
                        fullName = docSnap.data().fullName || fullName;
                        isVerifiedAdmin = docSnap.data().isVerified || false;
                    } else {
                        console.error("User doc not found!");
                    }

                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: fullName,
                        fullName: fullName,
                        isVerified: isVerifiedAdmin
                    };

                    updateNav(user, fullName);

                    if (window.location.hash === '#login' || window.location.hash === '#register' || window.location.hash === '') {
                        window.location.hash = 'main';
                    }
                    handleHashChange(); // Now async

                }).catch(err => {
                    console.error("Error fetching user doc:", err);
                    updateNav(user, user.displayName || user.email);
                    handleHashChange(); // Now async
                });
            } else {
                if (user && !user.emailVerified) {
                    console.log("User exists but email not verified.");
                    signOut(auth);
                }

                currentUser = null;
                console.log("User logged out or not verified.");
                updateNav(null);
                currentComplaintId = null;
                currentProfileId = null;
                cleanupListeners();

                const currentHash = window.location.hash.substring(1);
                if (!['login', 'register', 'email-verify'].includes(currentHash.split('?')[0])) {
                    window.location.hash = 'login';
                }
                await handleHashChange(); // Now async
            }
        });

        // --- NEW: Simplified Nav ---
        function updateNav(user, fullName) {
            const nameToShow = fullName || user?.email;
            // REMOVED: Theme logic
            let desktopHTML = '';
            let mobileHTML = '';

            if (user) {
                desktopHTML = `
                    <a href="#main" class="page-link text-slate-700 hover:text-teal-600 px-3 py-2 rounded-lg text-sm font-medium">الرئيسية</a>
                    <a href="#profile?id=${user.uid}" class="page-link text-slate-700 hover:text-teal-600 px-3 py-2 rounded-lg text-sm font-medium">ملفي الشخصي</a>
                    <button id="logout-btn-desktop" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition">تسجيل الخروج</button>
                `;
                mobileHTML = `
                    <a href="#main" class="page-link text-slate-700 hover:bg-slate-100 px-2 py-2 rounded-md block">الرئيسية</a>
                    <a href="#profile?id=${user.uid}" class="page-link text-slate-700 hover:bg-slate-100 px-2 py-2 rounded-md block">ملفي الشخصي</a>
                    <button id="logout-btn-mobile" class="w-full text-start bg-red-500/10 text-red-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-500/20 mt-2">تسجيل الخروج</button>
                `;
            } else {
                desktopHTML = `
                    <a href="#login" class="page-link text-slate-700 hover:text-teal-600 px-3 py-2 rounded-lg text-sm font-medium">دخول</a>
                    <a href="#register" class="page-link text-teal-600 bg-teal-100 px-3 py-2 rounded-lg text-sm font-medium hover:bg-teal-200">إنشاء حساب</a>
                `;
                mobileHTML = `
                    <a href="#login" class="page-link text-slate-700 hover:bg-slate-100 px-2 py-2 rounded-md block">دخول</a>
                    <a href="#register" class="page-link text-teal-600 bg-teal-100 px-3 py-2 rounded-lg text-sm font-medium hover:bg-teal-200 block">إنشاء حساب</a>
                `;
            }

            navLinksDesktop.innerHTML = desktopHTML;
            navLinksMobile.innerHTML = mobileHTML;

            // Add listeners for new buttons
            addNavListeners();
        }

        function addNavListeners() {
            // Logout
            document.getElementById('logout-btn-desktop')?.addEventListener('click', () => signOut(auth));
            document.getElementById('logout-btn-mobile')?.addEventListener('click', () => signOut(auth));

            // REMOVED: Theme Toggles
            // REMOVED: Profile Dropdown
        }

        // Mobile Menu Toggle
        mobileMenuBtn.addEventListener('click', () => {
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                mobileMenuBtn.innerHTML = `<i class="fa-solid fa-times text-xl"></i>`;
            } else {
                mobileMenu.classList.add('hidden');
                mobileMenuBtn.innerHTML = `<i class="fa-solid fa-bars text-xl"></i>`;
            }
        });


        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);

                if (!userCredential.user.emailVerified) {
                    await signOut(auth);
                    errorEl.textContent = "لم يتم التحقق من بريدك الإلكتروني. الرجاء الضغط على الرابط في رسالة التحقق.";
                    errorEl.classList.remove('hidden');
                    hideLoading();
                    return;
                }
                errorEl.classList.add('hidden');
            } catch (error) {
                console.error("Login error:", error.message);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorEl.textContent = "فشل تسجيل الدخول. تأكد من البريد الإلكتروني وكلمة المرور.";
                } else {
                    errorEl.textContent = "فشل تسجيل الدخول: " + error.message;
                }
                errorEl.classList.remove('hidden');
            } finally {
                if (!auth.currentUser) {
                    hideLoading();
                }
            }
        });


        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const name = document.getElementById('reg-name').value;
            const nid = document.getElementById('reg-nid').value;
            const phone = document.getElementById('reg-phone').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const errorEl = document.getElementById('register-error');

            if (typeof grecaptcha === 'undefined' || !grecaptcha) {
                grecaptcha = window.grecaptcha;
            }
            const recaptchaResponse = grecaptcha ? grecaptcha.getResponse() : null;
            const recaptchaErrorEl = document.getElementById('recaptcha-error');

            if (!recaptchaResponse || recaptchaResponse.length === 0) {
                recaptchaErrorEl.textContent = "الرجاء التأكيد أنك لست روبوت.";
                recaptchaErrorEl.classList.remove('hidden');
                hideLoading();
                return;
            }
            recaptchaErrorEl.classList.add('hidden');


            const nidValidation = validateNationalID(nid);
            if (!nidValidation.valid) {
                errorEl.textContent = `الرقم القومي غير صالح: ${nidValidation.error}`;
                errorEl.classList.remove('hidden');
                hideLoading();
                if (grecaptcha) grecaptcha.reset();
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await updateProfile(user, { displayName: name });

                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    fullName: name,
                    nationalID: nid,
                    phone: phone,
                    email: email,
                    createdAt: serverTimestamp(),
                    birthDate: nidValidation.data.birthDate.toISOString(),
                    governorate: nidValidation.data.governorate,
                    isVerified: false,
                    agreeCount: 0, // NEW: Initialize vote count
                    disagreeCount: 0 // NEW: Initialize vote count
                });

                await sendEmailVerification(user);
                console.log("Verification email sent.");

                await signOut(auth);
                showToast("تم إرسال رابط التحقق إلى بريدك.");
                registerForm.reset();
                if (grecaptcha) grecaptcha.reset();
                window.location.hash = 'email-verify';

            } catch (error) {
                console.error("Registration error:", error.message);
                if (error.code === 'auth/email-already-in-use') {
                    errorEl.textContent = "هذا البريد الإلكتروني مسجل بالفعل.";
                } else {
                    errorEl.textContent = "فشل التسجيل. " + error.message;
                }
                errorEl.classList.remove('hidden');
                if (grecaptcha) grecaptcha.reset();
            } finally {
                hideLoading();
            }
        });

        // --- National ID Validator ---
        regNidInput.addEventListener('input', (e) => {
            const nid = e.target.value;
            nidError.classList.add('hidden');
            nidSuccess.classList.add('hidden');

            if (nid.length === 14) {
                const result = validateNationalID(nid);
                if (result.valid) {
                    nidSuccess.textContent = `صالح. تاريخ الميلاد: ${result.data.birthDate.toLocaleDateString('ar-EG')}, المحافظة: ${result.data.governorate}`;
                    nidSuccess.classList.remove('hidden');
                } else {
                    nidError.textContent = result.error;
                    nidError.classList.remove('hidden');
                }
            }
        });

        function validateNationalID(nid) {
            if (!/^\d{14}$/.test(nid)) {
                return { valid: false, error: "الرقم القومي يجب أن يتكون من 14 رقم." };
            }

            const centuryDigit = parseInt(nid[0]);
            const year = parseInt(nid[1] + nid[2]);
            const month = parseInt(nid[3] + nid[4]);
            const day = parseInt(nid[5] + nid[6]);
            const govCode = parseInt(nid[7] + nid[8]);

            let fullYear;
            if (centuryDigit === 2) fullYear = 1900 + year;
            else if (centuryDigit === 3) fullYear = 2000 + year;
            else return { valid: false, error: "رقم القرن (الرقم الأول) غير صالح." };

            const birthDate = new Date(fullYear, month - 1, day);
            if (birthDate.getFullYear() !== fullYear || birthDate.getMonth() + 1 !== month || birthDate.getDate() !== day) {
                return { valid: false, error: "تاريخ الميلاد غير صالح." };
            }

            // Simplified gov map
            const govMap = {
                1: "القاهرة", 2: "الإسكندرية", 3: "بورسعيد", 4: "السويس", 11: "دمياط",
                12: "الدقهلية", 13: "الشرقية", 14: "القليوبية", 15: "كفر الشيخ", 16: "الغربية",
                17: "المنوفية", 18: "البحيرة", 19: "الإسماعيلية", 21: "الجيزة", 22: "بني سويف",
                23: "الفيوم", 24: "المنيا", 25: "أسيوط", 26: "سوهاج", 27: "قنا", 28: "أسوان",
                29: "الأقصر", 31: "البحر الأحمر", 32: "الوادي الجديد", 33: "مطروح", 34: "شمال سيناء",
                35: "جنوب سيناء", 88: "خارج الجمهورية"
            };
            const officialGovName = govMap[govCode];
            if (!officialGovName) {
                return { valid: false, error: "كود المحافظة (الرقم 8 و 9) غير صالح." };
            }

            return { valid: true, data: { birthDate: birthDate, governorate: officialGovName } };
        }

        // --- Maps ---

        async function initMainMap() {
            await loadLeaflet();
            if (mainMap) mainMap.remove();
            mainMap = L.map('map').setView([30.0444, 31.2357], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(mainMap);
        }

        async function initSubmitMap() {
            await loadLeaflet();
            if (submitMap) submitMap.remove();
            submitMap = L.map('submit-map').setView([30.0444, 31.2357], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(submitMap);

            submitMap.on('click', (e) => {
                const { lat, lng } = e.latlng;
                complaintLat.value = lat;
                complaintLng.value = lng;
                locationCoords.textContent = `الموقع المحدد: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                locationCoords.classList.remove('hidden');

                if (submitMarker) {
                    submitMarker.setLatLng(e.latlng);
                } else {
                    submitMarker = L.marker(e.latlng).addTo(submitMap);
                }
                submitMarker.bindPopup("موقع الشكوى").openPopup();
            });
        }

        async function initDetailMap(location) {
            await loadLeaflet();
            if (detailMap) {
                detailMap.remove();
                detailMap = null;
                detailMarker = null;
            }
            const mapContainer = document.getElementById('detail-map');
            if (mapContainer.classList.contains('hidden')) {
                mapContainer.classList.remove('hidden');
            }

            const { lat, lng } = location;
            detailMap = L.map('detail-map').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);

            detailMarker = L.marker([lat, lng]).addTo(detailMap);
            detailMarker.bindPopup("موقع الشكوى").openPopup();

            setTimeout(() => {
                if (detailMap) {
                    detailMap.invalidateSize();
                }
            }, 300);
        }

        function updateMainMapMarkers(complaints) {
            if (!mainMap) return;

            Object.values(complaintMarkers).forEach(marker => marker.remove());
            complaintMarkers = {};

            complaints.forEach(complaint => {
                if (complaint.location) {
                    const { lat, lng } = complaint.location;
                    const color = CATEGORIES[complaint.category]?.color || 'gray';

                    const marker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>`,
                            className: 'category-marker',
                            iconSize: [16, 16]
                        })
                    }).addTo(mainMap);

                    marker.bindPopup(`
                        <b style="color: ${color}">${getCategoryName(complaint.category)}</b>
                        <p>${complaint.description.substring(0, 50)}...</p>
                        <a href="#complaint-detail?id=${complaint.id}" class="page-link text-teal-600">عرض التفاصيل</a>
                    `);
                    complaintMarkers[complaint.id] = marker;
                }
            });
        }

        // --- View & Sort Toggles ---

        viewBtns.forEach(btn => {
            btn.addEventListener('click', async () => {
                viewBtns.forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');

                if (btn.id === 'feed-view-btn') {
                    feedView.classList.remove('hidden');
                    mapView.classList.add('hidden');
                } else {
                    feedView.classList.add('hidden');
                    mapView.classList.remove('hidden');
                    if (!mainMap) {
                        await initMainMap();
                        fetchComplaints(); // Markers won't be ready, need to fetch again
                    } else {
                        mainMap.invalidateSize();
                    }
                }
            });
        });

        sortBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                sortBtns.forEach(b => b.classList.remove('btn-active'));
                btn.classList.add('btn-active');
                currentSort = btn.dataset.sort;
                fetchComplaints(); // Re-fetch/re-sort
            });
        });

        // --- Complaints ---

        function cleanupListeners() {
            complaintListeners.forEach(unsubscribe => unsubscribe());
            complaintListeners = [];
            console.log("Cleaned up listeners");
        }

        function fetchComplaints() {
            if (!currentUser) return;
            cleanupListeners();
            // NEW: Show skeletons instead of global spinner
            renderFeedSkeletons();

            let complaintsQuery = collection(db, "complaints");
            const category = categoryFilter.value;
            // REMOVED: governorate

            // Build query with filters
            let filters = [];
            if (category !== 'all') {
                filters.push(where("category", "==", category));
            }
            // REMOVED: governorate filter logic

            if (filters.length > 0) {
                complaintsQuery = query(complaintsQuery, ...filters);
            }
            // REMOVED: composite index warning


            const unsubscribe = onSnapshot(complaintsQuery, (querySnapshot) => {
                const complaints = [];
                querySnapshot.forEach((doc) => {
                    complaints.push({ id: doc.id, ...doc.data() });
                });

                // Client-side sorting
                if (currentSort === 'newest') {
                    complaints.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                } else if (currentSort === 'hot') {
                    // Sort by highest score (up - down)
                    complaints.sort((a, b) => {
                        const scoreA = (a.upvotes || 0) - (a.downvotes || 0);
                        const scoreB = (b.upvotes || 0) - (b.downvotes || 0);
                        return scoreB - scoreA;
                    });
                }

                renderComplaintsFeed(complaints);
                if (!mapView.classList.contains('hidden') && mainMap) {
                    updateMainMapMarkers(complaints);
                }
                // Skeletons are cleared by renderComplaintsFeed
            }, (error) => {
                console.error("Error fetching complaints:", error);
                complaintsFeed.innerHTML = `<p class="text-center text-red-500">خطأ في تحميل الشكاوى.</p>`;
                showToast("خطأ في تحميل الشكاوى.", true);
            });

            complaintListeners.push(unsubscribe);
        }

        categoryFilter.addEventListener('change', fetchComplaints);
        // REMOVED: governorateFilter listener

        function getCategoryName(key) {
            return CATEGORIES[key]?.name || "فئة غير معروفة";
        }

        function getCategoryIcon(key) {
            return CATEGORIES[key]?.icon || "fa-question";
        }

        // --- NEW: Skeleton Loaders ---
        function renderFeedSkeletons() {
            complaintsFeed.innerHTML = ''; // Clear existing
            for (let i = 0; i < 3; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-card';
                skeleton.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full skeleton-line"></div>
                        <div class="flex-grow">
                            <div class="skeleton-line h-4 w-1/3 mb-2"></div>
                            <div class="skeleton-line h-3 w-1/2"></div>
                        </div>
                    </div>
                    <div class="skeleton-line h-4 w-full mt-4"></div>
                    <div class="skeleton-line h-4 w-3/4 mt-2"></div>
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100">
                        <div class="skeleton-line h-5 w-1/4"></div>
                        <div class="skeleton-line h-5 w-1/4"></div>
                    </div>
                `;
                complaintsFeed.appendChild(skeleton);
            }
        }

        function renderProfileSkeletons() {
            // Show header skeleton
            profileHeaderContent.classList.add('hidden');
            profileHeaderSkeleton.classList.remove('hidden');

            // Show list skeletons
            profileComplaintsList.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200 skeleton-card';
                skeleton.innerHTML = `
                    <div class="skeleton-line h-4 w-1/3 mb-3"></div>
                    <div class="skeleton-line h-4 w-full mb-2"></div>
                    <div class="skeleton-line h-4 w-1/2"></div>
                `;
                profileComplaintsList.appendChild(skeleton);
            }
        }

        function renderComplaintsFeed(complaints) {
            complaintsFeed.innerHTML = ''; // Clear skeletons
            if (complaints.length === 0) {
                complaintsFeed.innerHTML = `<p class="text-center text-slate-500">لا توجد شكاوى تطابق هذا الفلتر.</p>`;
                return;
            }

            complaints.forEach(complaint => {
                const complaintCard = document.createElement('div');
                // REMOVED: dark mode classes
                complaintCard.className = `bg-white p-5 rounded-xl shadow-lg transition-all duration-300 ease-in-out transform hover:shadow-xl hover:-translate-y-1 category-${complaint.category}`;

                const timeAgo = complaint.createdAt ? timeDifference(Date.now(), complaint.createdAt.toDate()) : 'منذ فترة';

                // Add verified badge check and profile link
                let authorDisplay;
                if (complaint.isAnonymous) {
                    authorDisplay = "مستخدم مجهول";
                } else {
                    const authorName = complaint.authorName || "مستخدم";
                    const verifiedBadge = complaint.authorIsVerified ?
                        '<i class="fa-solid fa-check-circle verified-badge" title="حساب موثق"></i>' : '';
                    authorDisplay = `<a href="#profile?id=${complaint.authorId}" class="page-link font-semibold text-sm text-slate-800 hover:text-teal-600">${authorName}${verifiedBadge}</a>`;
                }

                const upvotes = complaint.upvotes || 0;
                const downvotes = complaint.downvotes || 0;
                const score = upvotes - downvotes;
                let scoreColor = 'text-slate-600';
                if (score > 0) scoreColor = 'text-green-600';
                if (score < 0) scoreColor = 'text-red-600';

                complaintCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <!-- Author Info -->
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center">
                                <i class="fa-solid ${getCategoryIcon(complaint.category)} text-teal-600 text-lg"></i>
                            </div>
                            <div>
                                ${authorDisplay}
                                <div class="flex items-center gap-2 text-xs text-slate-500">
                                    <span>${getCategoryName(complaint.category)}</span>
                                    <!-- REMOVED: governorate -->
                                    <span>&middot;</span>
                                    <span>${timeAgo}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Complaint Text -->
                    <p class="mt-4 text-slate-700 leading-relaxed page-link cursor-pointer" data-target="#complaint-detail?id=${complaint.id}">
                        ${complaint.description.substring(0, 200)}
                        ${complaint.description.length > 200 ? '...' : ''}
                    </p>

                    <!-- Media Preview (if image exists) -->
                    ${complaint.imageUrl ? `
                        <div class="mt-4 rounded-lg overflow-hidden border border-gray-200">
                            <img src="${complaint.imageUrl}" alt="صورة الشكوى" class="w-full h-auto object-cover max-h-64" onerror="this.style.display='none'">
                        </div>
                    ` : ''}

                    <!-- Action Bar: Votes & Comments -->
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100">
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2 text-slate-500">
                                <i class="fa-solid fa-thumbs-up text-gray-400"></i>
                                <span class="font-medium ${scoreColor} text-sm">${score}</span>
                                <i class="fa-solid fa-thumbs-down text-gray-400"></i>
                            </div>
                            <a href="#complaint-detail?id=${complaint.id}" class="page-link flex items-center gap-2 text-slate-500 hover:text-teal-600">
                                <i class="fa-solid fa-comment-dots"></i>
                                <span class="text-sm font-medium">${complaint.commentCount || 0} تعليقات</span>
                            </a>
                        </div>
                        <a href="#complaint-detail?id=${complaint.id}" class="page-link text-teal-600 hover:text-teal-800 text-sm font-semibold">
                            عرض التفاصيل <i class="fa-solid fa-arrow-left me-1"></i>
                        </a>
                    </div>
                `;

                complaintCard.querySelectorAll('.page-link[data-target]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.hash = link.dataset.target.replace('#', '');
                    });
                });

                complaintsFeed.appendChild(complaintCard);
            });
        }

        function timeDifference(current, previous) {
            const msPerMinute = 60 * 1000;
            const msPerHour = msPerMinute * 60;
            const msPerDay = msPerHour * 24;
            const msPerMonth = msPerDay * 30;
            const msPerYear = msPerDay * 365;
            const elapsed = current - previous;
            if (elapsed < msPerMinute) { return 'الآن'; }
            else if (elapsed < msPerHour) { return 'منذ ' + Math.round(elapsed / msPerMinute) + ' د'; }
            else if (elapsed < msPerDay) { return 'منذ ' }
            else if (elapsed < msPerMonth) { return 'منذ ' + Math.round(elapsed / msPerDay) + ' ي'; }
            else if (elapsed < msPerYear) { return 'منذ ' + Math.round(elapsed / msPerMonth) + ' ش'; }
            else { return 'منذ ' + Math.round(elapsed / msPerYear) + ' س'; }
        }

        showSubmitFormBtn.addEventListener('click', () => {
            window.location.hash = 'submit-complaint';
        });

        submitComplaintForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            if (!complaintLat.value || !complaintLng.value) {
                document.getElementById('submit-complaint-error').textContent = 'الرجاء تحديد موقع على الخريطة.';
                document.getElementById('submit-complaint-error').classList.remove('hidden');
                return;
            }

            showLoading();
            const submitBtn = document.getElementById('submit-complaint-btn');
            submitBtn.disabled = true;

            const category = document.getElementById('complaint-category').value;
            // REMOVED: governorate
            const description = document.getElementById('complaint-description').value;
            const isAnonymous = document.getElementById('complaint-anonymous').checked;
            const imageUrl = complaintImageUrl.value || null;
            const videoUrl = complaintVideoUrl.value || null;

            try {
                const isVerified = currentUser.isVerified || false;

                // Fetch user's governorate from their profile
                const userDocRef = doc(db, "users", currentUser.uid);
                const userDocSnap = await getDoc(userDocRef);
                const userGovernorate = userDocSnap.exists() ? userDocSnap.data().governorate : null;

                await addDoc(collection(db, "complaints"), {
                    category: category,
                    governorate: userGovernorate, // NEW: Add user's governorate automatically
                    description: description,
                    location: {
                        lat: parseFloat(complaintLat.value),
                        lng: parseFloat(complaintLng.value)
                    },
                    imageUrl: imageUrl,
                    videoUrl: videoUrl,
                    isAnonymous: isAnonymous,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorIsVerified: isVerified,
                    createdAt: serverTimestamp(),
                    upvotes: 0,
                    downvotes: 0,
                    voteMap: {},
                    commentCount: 0
                });

                showToast("تم إرسال الشكوى بنجاح!");
                submitComplaintForm.reset();
                locationCoords.classList.add('hidden');
                complaintImageUrl.value = '';
                complaintVideoUrl.value = '';
                if (submitMarker) submitMarker.remove();
                submitMarker = null;

                window.location.hash = 'main';

            } catch (error) {
                console.error("Error submitting complaint:", error);
                document.getElementById('submit-complaint-error').textContent = 'حدث خطأ أثناء إرسال الشكوى.';
                document.getElementById('submit-complaint-error').classList.remove('hidden');
            } finally {
                hideLoading();
                submitBtn.disabled = false;
            }
        });

        // --- Complaint Detail, Voting, Comments ---

        async function fetchComplaintDetails() {
            if (!currentComplaintId || !currentUser) {
                window.location.hash = 'main';
                return;
            }

            if (detailMap) {
                detailMap.remove();
                detailMap = null;
                detailMarker = null;
            }
            showLoading(); // Use global spinner here, not skeleton
            cleanupListeners();

            const complaintRef = doc(db, "complaints", currentComplaintId);

            const unsubComplaint = onSnapshot(complaintRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const complaintData = docSnap.data();
                    renderComplaintDetail(complaintData, docSnap.id);

                    const mapContainer = document.getElementById('detail-map');
                    if (complaintData.location && complaintData.location.lat && complaintData.location.lng) {
                        mapContainer.classList.remove('hidden');
                        await initDetailMap(complaintData.location);
                    } else {
                        mapContainer.classList.add('hidden');
                    }

                    updateVoteUI(complaintData.voteMap || {});
                } else {
                    console.error("Complaint not found");
                    showToast("لم يتم العثور على الشكوى.", true);
                    window.location.hash = 'main';
                }
                hideLoading();
            }, (error) => {
                console.error("Error fetching complaint details:", error);
                hideLoading();
            });

            complaintListeners.push(unsubComplaint);

            // Fetch comments
            const commentsRef = collection(db, "complaints", currentComplaintId, "comments");
            const commentsQuery = query(commentsRef, orderBy("createdAt", "asc"));

            const unsubComments = onSnapshot(commentsQuery, (querySnapshot) => {
                const comments = [];
                querySnapshot.forEach((doc) => {
                    comments.push({ id: doc.id, ...doc.data() });
                });
                renderComments(comments);
            }, (error) => {
                console.error("Error fetching comments:", error);
            });

            complaintListeners.push(unsubComments);
        }

        function renderComplaintDetail(complaint, id) {
            // Add verified badge check and profile link
            let authorDisplay;
            if (complaint.isAnonymous) {
                authorDisplay = "مستخدم مجهول";
            } else {
                const authorName = complaint.authorName || "مستخدم";
                const verifiedBadge = complaint.authorIsVerified ?
                    '<i class="fa-solid fa-check-circle verified-badge" title="حساب موثق"></i>' : '';
                authorDisplay = `<a href="#profile?id=${complaint.authorId}" class="page-link text-slate-600 hover:text-teal-600">${authorName}${verifiedBadge}</a>`;
            }

            const timeAgo = complaint.createdAt ? timeDifference(Date.now(), complaint.createdAt.toDate()) : 'منذ فترة';

            complaintDetailContent.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="px-3 py-1 bg-teal-100 text-teal-800 rounded-full text-sm font-semibold">
                        <i class="fa-solid ${getCategoryIcon(complaint.category)} me-1"></i>
                        ${getCategoryName(complaint.category)}
                    </span>
                    <span class="text-sm text-slate-500">${timeAgo}</span>
                </div>
                <!-- REMOVED: Show governorate -->
                <p class="text-slate-800 my-4 text-lg leading-relaxed">${complaint.description}</p>
                <div class="text-sm text-slate-600">بواسطة: ${authorDisplay}</div>
            `;

            complaintMedia.innerHTML = '';
            if (complaint.imageUrl || complaint.videoUrl) {
                let mediaHTML = '<h3 class="text-lg font-semibold mb-2">المرفقات</h3>';
                if (complaint.imageUrl) {
                    mediaHTML += `
                        <a href="${complaint.imageUrl}" target="_blank" class="block mb-2">
                            <img src="${complaint.imageUrl}" alt="صورة مرفقة" class="rounded-lg border border-gray-200 max-w-full h-auto">
                        </a>
                    `;
                }
                if (complaint.videoUrl) {
                    mediaHTML += `
                        <a href="${complaint.videoUrl}" target="_blank" class="flex items-center text-teal-600 hover:text-teal-800 text-sm font-medium">
                            <i class="fa-solid fa-video me-2"></i> رابط الفيديو المرفق
                        </a>
                    `;
                }
                complaintMedia.innerHTML = mediaHTML;
            }

            upvoteCount.textContent = complaint.upvotes || 0;
            downvoteCount.textContent = complaint.downvotes || 0;
        }

        function updateVoteUI(voteMap) {
            if (!currentUser) return;
            const myVote = voteMap[currentUser.uid];

            upvoteBtn.classList.remove('bg-green-100', 'text-green-700', 'border-green-500');
            downvoteBtn.classList.remove('bg-red-100', 'text-red-700', 'border-red-500');
            // REMOVED: dark mode classes

            if (myVote) {
                if (myVote === 'up') {
                    upvoteBtn.classList.add('bg-green-100', 'text-green-700', 'border-green-500');
                    upvoteBtn.disabled = true;
                } else if (myVote === 'down') {
                    downvoteBtn.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                    downvoteBtn.disabled = true;
                }
                commentForm.classList.remove('hidden');
                voteMessage.classList.add('hidden');
            } else {
                upvoteBtn.disabled = false;
                downvoteBtn.disabled = false;
                commentForm.classList.add('hidden');
                voteMessage.classList.remove('hidden');
            }
        }

        upvoteBtn.addEventListener('click', () => handleVote('up'));
        downvoteBtn.addEventListener('click', () => handleVote('down'));

        async function handleVote(voteType) {
            if (!currentUser || !currentComplaintId) return;

            showLoading();
            const complaintRef = doc(db, "complaints", currentComplaintId);
            const userRef = doc(db, "users", currentUser.uid); // User ref

            try {
                await runTransaction(db, async (transaction) => {
                    const complaintDoc = await transaction.get(complaintRef);
                    if (!complaintDoc.exists()) {
                        throw "Complaint does not exist!";
                    }

                    const data = complaintDoc.data();
                    const voteMap = data.voteMap || {};

                    if (voteMap[currentUser.uid]) {
                        throw "لا يمكن تغيير التصويت بعد الإدلاء به";
                    }

                    let newUpvotes = data.upvotes || 0;
                    let newDownvotes = data.downvotes || 0;
                    voteMap[currentUser.uid] = voteType;

                    // Update user's vote counts
                    if (voteType === 'up') {
                        newUpvotes++;
                        transaction.update(userRef, { agreeCount: increment(1) });
                    }
                    if (voteType === 'down') {
                        newDownvotes++;
                        transaction.update(userRef, { disagreeCount: increment(1) });
                    }

                    transaction.update(complaintRef, {
                        voteMap: voteMap,
                        upvotes: newUpvotes,
                        downvotes: newDownvotes
                    });
                });

                showToast("تم تسجيل تصويتك بنجاح!");
            } catch (error) {
                console.error("Error voting:", error);
                if (error.message && error.message.includes("لا يمكن تغيير التصويت")) {
                    showToast("لا يمكن تغيير التصويت بعد الإدلاء به", true);
                } else {
                    showToast("خطأ أثناء التصويت.", true);
                }
            } finally {
                hideLoading();
            }
        }

        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !currentComplaintId) return;

            const submitBtn = document.getElementById('submit-comment-btn');
            submitBtn.disabled = true;
            showLoading();

            const text = document.getElementById('comment-text').value;

            try {
                const complaintRef = doc(db, "complaints", currentComplaintId);
                const complaintDoc = await getDoc(complaintRef);
                const voteMap = complaintDoc.data().voteMap || {};
                const userVote = voteMap[currentUser.uid];

                const isVerified = currentUser.isVerified || false;

                const commentsRef = collection(db, "complaints", currentComplaintId, "comments");
                await addDoc(commentsRef, {
                    text: text,
                    fileURL: null,
                    authorId: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorIsVerified: isVerified,
                    voteType: userVote,
                    createdAt: serverTimestamp()
                });

                const newCount = (complaintDoc.data().commentCount || 0) + 1;
                await updateDoc(complaintRef, { commentCount: newCount });

                commentForm.reset();
                showToast("تم إضافة تعليقك.");

            } catch (error) {
                console.error("Error adding comment:", error);
                showToast("خطأ أثناء إضافة التعليق.", true);
            } finally {
                hideLoading();
                submitBtn.disabled = false;
            }
        });

        function renderComments(comments) {
            commentsList.innerHTML = '';
            if (comments.length === 0) {
                commentsList.innerHTML = `<p class="text-center text-slate-500 p-4">لا توجد تعليقات حتى الآن.</p>`;
                return;
            }

            comments.forEach(comment => {
                const timeAgo = comment.createdAt ? timeDifference(Date.now(), comment.createdAt.toDate()) : 'منذ فترة';

                let voteStatus = '';
                if (comment.voteType) {
                    const voteClass = comment.voteType === 'up' ? 'vote-status-agree' : 'vote-status-disagree';
                    const voteText = comment.voteType === 'up' ? 'يوافق' : 'لا يوافق';
                    voteStatus = `<span class="vote-status ${voteClass}">${voteText}</span>`;
                }

                // Add verified badge check and profile link
                const authorName = comment.authorName || "مستخدم";
                const verifiedBadge = comment.authorIsVerified ?
                    '<i class="fa-solid fa-check-circle verified-badge" title="حساب موثق"></i>' : '';
                const authorDisplay = `<a href="#profile?id=${comment.authorId}" class="page-link font-semibold text-slate-800 text-sm hover:text-teal-600">${authorName}${verifiedBadge}</a>`;


                const commentEl = document.createElement('div');
                commentEl.className = "bg-slate-50 p-4 rounded-lg flex gap-3";
                commentEl.innerHTML = `
                    <div class="w-8 h-8 bg-slate-200 rounded-full flex-shrink-0 flex items-center justify-center">
                        <i class="fa-solid fa-user text-slate-500"></i>
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                ${voteStatus}
                                ${authorDisplay}
                            </div>
                            <span class="text-xs text-slate-500">${timeAgo}</span>
                        </div>
                        <p class="text-slate-700 mt-2">${comment.text}</p>
                    </div>
                `;
                commentsList.appendChild(commentEl);
            });
        }

        // --- Profile Page ---

        async function loadProfilePage() {
            // Get profile ID from global state (set by hash change) or use current user
            const userId = currentProfileId || currentUser?.uid;
            if (!userId) {
                showToast("User ID not found.", true);
                window.location.hash = 'main';
                return;
            }

            // NEW: Show skeletons
            renderProfileSkeletons();
            // Reset page (in case skeletons don't cover everything)
            profileName.textContent = '...';
            profileVerifiedBadge.classList.add('hidden');
            profilePostCount.textContent = '...';
            profileAgreeCount.textContent = '...';
            profileDisagreeCount.textContent = '...';

            try {
                // 1. Fetch user data
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);

                // Show header content, hide skeleton
                profileHeaderContent.classList.remove('hidden');
                profileHeaderSkeleton.classList.add('hidden');

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    // NEW: Add "مرحباً"
                    profileName.textContent = `مرحباً، ${userData.fullName}`;
                    if (userData.isVerified) {
                        profileVerifiedBadge.classList.remove('hidden');
                    }
                    profileAgreeCount.textContent = userData.agreeCount || 0;
                    profileDisagreeCount.textContent = userData.disagreeCount || 0;

                } else {
                    profileName.textContent = 'مستخدم غير معروف';
                    showToast("User not found.", true);
                }

                // 2. Fetch user's complaints (NON-ANONYMOUS ONLY)
                const complaintsRef = collection(db, "complaints");
                const q = query(complaintsRef,
                    where("authorId", "==", userId),
                    where("isAnonymous", "==", false),
                    orderBy("createdAt", "desc")
                );

                const complaintQuerySnap = await getDocs(q);

                const userComplaints = [];
                complaintQuerySnap.forEach(doc => {
                    userComplaints.push({ id: doc.id, ...doc.data() });
                });

                // 3. Render stats and complaints
                profilePostCount.textContent = userComplaints.length;
                renderProfileComplaints(userComplaints); // This will clear skeletons

            } catch (error) {
                console.error("Error loading profile:", error);
                if (error.code === 'failed-precondition') {
                    profileComplaintsList.innerHTML = `<p class="text-center text-red-500">خطأ: يتطلب هذا الاستعلام فهرسًا. راجع الكونسول.</p>`;
                    showToast("خطأ: يتطلب هذا الاستعلام فهرسًا. راجع وحدة التحكم.", true);
                    console.error("FIRESTORE INDEX REQUIRED: Go to Firestore > Indexes and create a composite index for 'complaints' on [authorId (ASC), isAnonymous (ASC), createdAt (DESC)]");
                } else {
                    showToast("خطأ في تحميل صفحة الملف الشخصي.", true);
                }
            } finally {
                // Hide skeletons just in case
                profileHeaderContent.classList.remove('hidden');
                profileHeaderSkeleton.classList.add('hidden');
            }
        }

        function renderProfileComplaints(complaints) {
            profileComplaintsList.innerHTML = ''; // Clear skeletons
            if (complaints.length === 0) {
                profileComplaintsList.innerHTML = `<p class="text-center text-slate-500">لم يقم هذا المستخدم بنشر أي شكاوى علنية.</p>`;
                return;
            }

            complaints.forEach(complaint => {
                const card = document.createElement('div');
                card.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                const timeAgo = complaint.createdAt ? timeDifference(Date.now(), complaint.createdAt.toDate()) : '...';

                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-teal-700">${getCategoryName(complaint.category)}</span>
                    </div>
                    <p class="text-slate-800">${complaint.description.substring(0, 150)}...</p>
                    <div class="flex justify-between items-center mt-3 text-sm text-slate-500">
                        <span>${timeAgo}</span>
                        <div class="flex gap-4">
                            <span><i class="fa-solid fa-thumbs-up ms-1"></i> ${complaint.upvotes || 0}</span>
                            <span><i class="fa-solid fa-thumbs-down ms-1"></i> ${complaint.downvotes || 0}</span>
                            <a href="#complaint-detail?id=${complaint.id}" class="page-link font-semibold text-teal-600 hover:text-teal-800">
                                عرض التفاصيل <i class="fa-solid fa-arrow-left me-1"></i>
                            </a>
                        </div>
                    </div>
                `;
                profileComplaintsList.appendChild(card);
            });
        }


        // --- Init ---

        function populateDropdowns() {
            // REMOVED: Governorates

            // Map Legend
            mapLegend.innerHTML = '';
            Object.keys(CATEGORIES).forEach(key => {
                const item = CATEGORIES[key];
                const li = document.createElement('li');
                li.className = 'flex items-center gap-2';
                li.innerHTML = `
                    <span class="w-3 h-3 rounded-full" style="background-color: ${item.color}; border: 1px solid rgba(0,0,0,0.2)"></span>
                    <span>${item.name}</span>
                `;
                mapLegend.appendChild(li);
            });
        }

        window.addEventListener('hashchange', handleHashChange);
        profileLogoutBtn.addEventListener('click', () => signOut(auth)); // NEW

        // Set grecaptcha when it loads
        window.onload = () => {
            if (window.grecaptcha) {
                grecaptcha = window.grecaptcha;
            }
        };

        // --- App Start ---
        // REMOVED: initTheme()
        populateDropdowns();

        // Trigger initial check
        const initialHash = window.location.hash;
        window.location.hash = ''; // Clear hash
        window.location.hash = initialHash; // Set it back to trigger change
        if (initialHash === '') {
            handleHashChange(); // Handle empty hash case
        }

    </script>
</body>

</html>
